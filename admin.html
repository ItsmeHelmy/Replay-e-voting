<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Replay E-Voting</title>
    <link rel="icon" type="image/png" href="images/replay-logo.png" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        color: #fff;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        padding: 30px 0;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 2.5rem;
        color: #00d4ff;
        text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
      }

      header p {
        color: #888;
        margin-top: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-card h3 {
        font-size: 3rem;
        color: #00d4ff;
        margin-bottom: 10px;
      }

      .stat-card p {
        color: #aaa;
        font-size: 1rem;
      }

      .results-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }

      .result-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .result-card h2 {
        color: #00d4ff;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .candidate-result {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
      }

      .candidate-info {
        flex: 1;
      }

      .candidate-name {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .vote-count {
        color: #888;
        font-size: 0.9rem;
      }

      .progress-bar {
        width: 100%;
        height: 25px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00d4ff, #0099cc);
        border-radius: 12px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .progress-fill.lead1 {
        background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
      }
      .progress-fill.lead2 {
        background: linear-gradient(90deg, #4ecdc4, #45b7aa);
      }
      .progress-fill.colead1 {
        background: linear-gradient(90deg, #a29bfe, #8b7cf7);
      }
      .progress-fill.colead2 {
        background: linear-gradient(90deg, #ffeaa7, #fdcb6e);
      }

      .recent-votes {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 30px;
      }

      .recent-votes h2 {
        color: #00d4ff;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      th {
        color: #00d4ff;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.05);
      }

      tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-refresh {
        background: linear-gradient(90deg, #00d4ff, #0099cc);
        color: #fff;
      }

      .btn-refresh:hover {
        box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
      }

      .btn-reset {
        background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
        color: #fff;
      }

      .btn-reset:hover {
        box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
      }

      .btn-export {
        background: linear-gradient(90deg, #4ecdc4, #45b7aa);
        color: #fff;
      }

      .btn-export:hover {
        box-shadow: 0 5px 20px rgba(78, 205, 196, 0.4);
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 212, 255, 0.1);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .live-dot {
        width: 10px;
        height: 10px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #888;
      }

      .auto-refresh input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .last-update {
        color: #666;
        font-size: 0.9rem;
      }

      .winner-badge {
        background: linear-gradient(90deg, #ffd700, #ffb700);
        color: #1a1a2e;
        padding: 3px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        margin-left: 10px;
        font-weight: bold;
      }

      @media (max-width: 768px) {
        .results-section {
          grid-template-columns: 1fr;
        }

        header h1 {
          font-size: 1.8rem;
        }

        .stat-card h3 {
          font-size: 2rem;
        }

        table {
          font-size: 0.85rem;
        }

        th,
        td {
          padding: 8px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üìä ADMIN PANEL - HASIL VOTING</h1>
        <p>Real-time Monitoring Pemilihan Ketua & Wakil Ketua</p>
        <div style="margin-top: 15px">
          <span class="live-indicator">
            <span class="live-dot"></span>
            LIVE
          </span>
        </div>
      </header>

      <div class="controls">
        <button class="btn btn-refresh" onclick="fetchResults()">
          üîÑ Refresh Data
        </button>
        <button class="btn btn-export" onclick="exportData()">
          üì• Export CSV
        </button>
        <button class="btn btn-reset" onclick="resetVotes()">
          üóëÔ∏è Reset Semua Suara
        </button>
        <div class="auto-refresh">
          <input type="checkbox" id="autoRefresh" checked />
          <label for="autoRefresh">Auto-refresh (5 detik)</label>
        </div>
        <span class="last-update" id="lastUpdate">Last update: -</span>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalVotes">0</h3>
          <p>Total Suara Masuk</p>
        </div>
        <div class="stat-card">
          <h3 id="leadVotes">0</h3>
          <p>Suara Ketua</p>
        </div>
        <div class="stat-card">
          <h3 id="coleadVotes">0</h3>
          <p>Suara Wakil Ketua</p>
        </div>
      </div>

      <div class="results-section">
        <div class="result-card">
          <h2>üèÜ Calon Ketua</h2>
          <div id="leadResults">
            <p style="color: #888; text-align: center">Loading...</p>
          </div>
        </div>

        <div class="result-card">
          <h2>ü•à Calon Wakil Ketua</h2>
          <div id="coleadResults">
            <p style="color: #888; text-align: center">Loading...</p>
          </div>
        </div>
      </div>

      <div class="recent-votes">
        <h2>üìù Suara Terbaru</h2>
        <div style="overflow-x: auto">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>UUID</th>
                <th>Ketua</th>
                <th>Wakil Ketua</th>
                <th>Tanggal</th>
                <th>Waktu</th>
              </tr>
            </thead>
            <tbody id="recentVotesTable">
              <tr>
                <td colspan="6" style="text-align: center; color: #888">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      let autoRefreshInterval = null;

      // Candidate name mapping
      const candidateNames = {
        lead1: "Farizal",
        lead2: "Ridwan",
        colead1: "Dea",
        colead2: "Keisya",
      };

      async function fetchResults() {
        try {
          const response = await fetch(`${API_BASE}/api/results`);
          const data = await response.json();

          if (data.success) {
            updateStats(data);
            updateLeadResults(data.leadResults, data.totalVotes);
            updateColeadResults(data.coleadResults, data.totalVotes);
            updateRecentVotes(data.recentVotes);
            updateLastUpdateTime();
          }
        } catch (error) {
          console.error("Error fetching results:", error);
        }
      }

      function updateStats(data) {
        document.getElementById("totalVotes").textContent = data.totalVotes;

        const leadTotal = data.leadResults.reduce((sum, r) => sum + r.votes, 0);
        const coleadTotal = data.coleadResults.reduce(
          (sum, r) => sum + r.votes,
          0,
        );

        document.getElementById("leadVotes").textContent = leadTotal;
        document.getElementById("coleadVotes").textContent = coleadTotal;
      }

      function updateLeadResults(results, total) {
        const container = document.getElementById("leadResults");

        if (results.length === 0) {
          container.innerHTML =
            '<p style="color: #888; text-align: center;">Belum ada suara</p>';
          return;
        }

        // Find winner
        const maxVotes = Math.max(...results.map((r) => r.votes));

        let html = "";
        results.forEach((result) => {
          const percentage =
            total > 0 ? ((result.votes / total) * 100).toFixed(1) : 0;
          const isWinner = result.votes === maxVotes && result.votes > 0;
          const name =
            result.name ||
            candidateNames[result.candidate_id] ||
            result.candidate_id;

          html += `
                    <div class="candidate-result">
                        <div class="candidate-info">
                            <div class="candidate-name">
                                ${name}
                                ${isWinner ? '<span class="winner-badge">LEADING</span>' : ""}
                            </div>
                            <div class="vote-count">${result.votes} suara</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${result.candidate_id}" style="width: ${percentage}%">
                                    ${percentage}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      function updateColeadResults(results, total) {
        const container = document.getElementById("coleadResults");

        if (results.length === 0) {
          container.innerHTML =
            '<p style="color: #888; text-align: center;">Belum ada suara</p>';
          return;
        }

        // Find winner
        const maxVotes = Math.max(...results.map((r) => r.votes));

        let html = "";
        results.forEach((result) => {
          const percentage =
            total > 0 ? ((result.votes / total) * 100).toFixed(1) : 0;
          const isWinner = result.votes === maxVotes && result.votes > 0;
          const name =
            result.name ||
            candidateNames[result.candidate_id] ||
            result.candidate_id;

          html += `
                    <div class="candidate-result">
                        <div class="candidate-info">
                            <div class="candidate-name">
                                ${name}
                                ${isWinner ? '<span class="winner-badge">LEADING</span>' : ""}
                            </div>
                            <div class="vote-count">${result.votes} suara</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${result.candidate_id}" style="width: ${percentage}%">
                                    ${percentage}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      function updateRecentVotes(votes) {
        const tbody = document.getElementById("recentVotesTable");

        if (votes.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: #888;">Belum ada suara</td></tr>';
          return;
        }

        let html = "";
        votes.forEach((vote, index) => {
          const leadName = candidateNames[vote.lead] || vote.lead;
          const coleadName = candidateNames[vote.colead] || vote.colead;

          html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-family: monospace; font-size: 0.8rem;">${vote.uuid.substring(0, 8)}...</td>
                        <td>${leadName}</td>
                        <td>${coleadName}</td>
                        <td>${vote.input_date}</td>
                        <td>${vote.input_time}</td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
      }

      function updateLastUpdateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        });
        document.getElementById("lastUpdate").textContent =
          `Last update: ${timeStr}`;
      }

      async function resetVotes() {
        if (
          !confirm(
            "‚ö†Ô∏è PERINGATAN!\n\nApakah Anda yakin ingin menghapus SEMUA suara?\nTindakan ini tidak dapat dibatalkan!",
          )
        ) {
          return;
        }

        if (
          !confirm(
            "üî¥ KONFIRMASI TERAKHIR\n\nSemua data voting akan dihapus permanen.\nLanjutkan?",
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/api/votes/reset`, {
            method: "DELETE",
          });
          const data = await response.json();

          if (data.success) {
            alert("‚úÖ Semua suara telah direset");
            fetchResults();
          } else {
            alert("‚ùå Gagal mereset suara");
          }
        } catch (error) {
          console.error("Error resetting votes:", error);
          alert("‚ùå Terjadi kesalahan");
        }
      }

      async function exportData() {
        try {
          const response = await fetch(`${API_BASE}/api/votes`);
          const data = await response.json();

          if (data.success && data.votes.length > 0) {
            // Create CSV content
            const headers = [
              "UUID",
              "Lead",
              "CoLead",
              "Date",
              "Time",
              "Timestamp",
            ];
            let csv = headers.join(",") + "\n";

            data.votes.forEach((vote) => {
              const leadName = candidateNames[vote.lead] || vote.lead;
              const coleadName = candidateNames[vote.colead] || vote.colead;
              csv += `${vote.uuid},${leadName},${coleadName},${vote.input_date},${vote.input_time},${vote.timestamp}\n`;
            });

            // Download file
            const blob = new Blob([csv], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `voting_results_${new Date().toISOString().split("T")[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          } else {
            alert("Tidak ada data untuk di-export");
          }
        } catch (error) {
          console.error("Error exporting data:", error);
          alert("‚ùå Gagal export data");
        }
      }

      // Auto-refresh toggle
      document
        .getElementById("autoRefresh")
        .addEventListener("change", function () {
          if (this.checked) {
            startAutoRefresh();
          } else {
            stopAutoRefresh();
          }
        });

      function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(fetchResults, 5000);
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      // Initial load
      fetchResults();
      startAutoRefresh();
    </script>
  </body>
</html>
